---
title: "Preliminary analyses for Minnesota beta diversity"
output: html_notebook
#root.dir: '/Users/Eric/Dropbox/Eric/Work/JKL/Theses/Matti_Hakkila/paper_4/'
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# set global chunk options
knitr::opts_knit$set(root.dir = normalizePath('/Users/Eric/Dropbox/Eric/Work/JKL/Theses/Matti_Hakkila/paper_4/'))
```

##Load necessary packages
```{r, results = 'hide'}
library(rgdal)
library(maptools)
library(dplyr)
library(rgeos)
library(raster)
library(dplyr)
```

##Prepare vector data
First, we prepare the vector data by joining all unit-level data together
```{r, results = 'hide'}
# Read the different unit-level shapefiles
units <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units.shp', 'Units')
units_census <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units_Census.shp', 'Units_Census')
units_eco_subsection <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units_EcoSubsection.shp', 'Units_EcoSubsection')
units_forest_status <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units_ForestStatus.shp', 'Units_ForestStatus')
units_land_fire <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units_Landfire.shp', 'Units_Landfire')
units_prism <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units_PRISM.shp', 'Units_PRISM')
units_road_density <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/Units_RoadDensity.shp', 'Units_RoadDensity')

# Join attributes of unit- level shapefiles
units_merged <- units
units_merged@data <- inner_join(units_merged@data, units_eco_subsection@data, by = 'unit')
units_merged@data <- inner_join(units_merged@data, units_census@data, by = 'unit')
units_merged@data <- inner_join(units_merged@data, units_prism@data, by = 'unit')
units_merged@data <- inner_join(units_merged@data, units_forest_status@data, by = 'unit')
units_merged@data <- inner_join(units_merged@data, units_road_density@data, by = 'unit')
units_merged@data <- inner_join(units_merged@data, units_land_fire@data, by = 'unit')
units_merged@data$Dens_Minor <- as.numeric(units_merged@data$Dens_Minor)

# Save the joined data as a shapefile
writeOGR(units_merged, './data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/units_merged.shp', 'units_merged', driver = 'ESRI Shapefile', overwrite_layer = T)
```

We then print the name and type for each column of the joined unit-level data
```{r}
sapply(units_merged@data, class)
```

##Prepare other data
```{r, results = 'hide'}
forest_status <- raster('./data/Minnesota_bird_data/MNBBA_Homogenization_GISFiles_8_2015/Forest_Status/forstat_rast.tif')
units_merged <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Units Spatial Data/units_merged.shp', 'units_merged')
mnn_bba_points <- readOGR('./data/Minnesota_bird_data/MNBBA_Homogenization_Data_9_22_2015/Bird Data/MNBBA_Surveys_DominantHabitat_Final.shp', 'MNBBA_Surveys_DominantHabitat_Final')
```

For the purpose of determining how many forested BBA points there are per unit,
we read in and reclassify the forest status raster so that forested pixels have 
a value of 1. We then extract the forest cover values to the BBA point data, and 
use this later to count the number of BBA points in forested areas per unit.

```{r}
# Reclassify forest status raster so that forested pixels have a value of 1
reclass_matrix <- matrix(c(1, 4, 1), ncol = 3, byrow = TRUE)
forest_cover <- reclassify(forest_status, reclass_matrix)

# Extract forest cover values with BBA, so that BBA points in forested pixels 
# have a value of 1, and non-forested points have a value of 0
forest_points <- extract(forest_cover, mnn_bba_points)
forest_points[is.na(forest_points)] <- 0
mnn_bba_points@data$forest <- forest_points
```

We continue by calculating how many unique BBA points fall within each unit. It 
seems like some units have BBA points that have been counted in multiple years. 
For this, we use the 'block_poin' column in the BBA data.
```{r}
# Select unique points based on the 'block_poin' column
mnn_bba_points_unique <- mnn_bba_points[which(!duplicated(mnn_bba_points@data$block_poin)), ]

# Calculate the number of unique BBA points within each unit
units_points <- over(mnn_bba_points_unique, units_merged)
units_points_count <- data.frame(table(units_points$unit))
colnames(units_points_count) <- c('unit', 'point_freq')
units_points_count$unit <- as.numeric(as.character(units_points_count$unit))
units_points_freq <- left_join(units_merged@data, units_points_count)
units_points_freq$point_freq[is.na(units_points_freq$point_freq)] <- 0

# Summarise how many unique BBA points units have
point_freq <- as.data.frame(table(units_points_freq$point_freq))
colnames(point_freq) <- c('points per unit', 'freq')
print.data.frame(point_freq)
hist(units_points_freq$point_freq, breaks = 18, xlim = c(0, 20), xlab = 'Number 
of BBA points', main = 'BBA points per unit')
```

We then calculate the number of BBA points in forested areas per unit.
```{r}
# Select only BBA points in forested pixels
mnn_bba_points_forest <- mnn_bba_points_unique[mnn_bba_points_unique@data$forest == 1, ]

# Calculate the number of BBA points in forested pixels within each unit
units_forest_points <- over(mnn_bba_points_forest, units_merged)
units_forest_points_count <- data.frame(table(units_forest_points$unit))
colnames(units_forest_points_count) <- c('unit', 'forest_point_freq')
units_forest_points_count$unit <- as.numeric(as.character(units_forest_points_count$unit))
units_merged_forest_freq <- left_join(units_merged@data, units_forest_points_count)
units_merged_forest_freq$forest_point_freq[is.na(units_merged_forest_freq$forest_point_freq)] <- 0

# Summarise how many unique BBA points in forest pixels units have
forest_point_freq <- as.data.frame(table(units_merged_forest_freq$forest_point_freq))
colnames(forest_point_freq) <- c('forested points per unit', 'freq')
print.data.frame(forest_point_freq)
hist(units_merged_forest_freq$forest_point_freq, breaks = 15, xlim = c(0, 15), xlab = 'Number 
of forested BBA points', main = 'Forested BBA points per unit')
```

We can then choose units with at leas two BBA points in forested pixels
```{r}
# Select units that have at least 2 forested unique BBA points in them
units_merged_subset <- units_merged_forest_freq[units_merged_forest_freq$forest_point_freq >= 2, ]
dim(units_merged_subset)
hist(units_merged_subset$forest_point_freq)
```
We can see that with a minimum of 2 BBA points in forested pixels per unit, we 
have a total of 
```{r, include = FALSE}
paste0(dim(units_merged_subset)[1])
```
units